<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Doggo Hub</title>
    <style>
        :root {
            --bg: #0f1220;
            --panel: #181c2f;
            --accent: #4da3ff;
            --text: #e6e8f0;
            --muted: #9aa0b3;
            --danger: #ff5d5d;
            --ok: #3ddc97;
            --warn: #ffd166;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: var(--bg);
            color: var(--text);
        }

        .wrap {
            display: grid;
            grid-template-columns: 460px 1fr;
            gap: 12px;
            padding: 12px;
            min-height: 100vh;
        }

        .panel {
            background: var(--panel);
            border-radius: 16px;
            padding: 14px;
        }

        h1 { margin: 0 0 10px; font-size: 18px; }
        .muted { color: var(--muted); font-size: 13px; }

        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .col { display: flex; flex-direction: column; gap: 10px; }

        button {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .18);
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
        }

        button.primary { border-color: var(--accent); color: var(--accent); }
        button.danger { border-color: var(--danger); color: var(--danger); }
        button:disabled { opacity: .35; cursor: not-allowed; }

        .badge {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: #0f1220;
            font-size: 13px;
        }

        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); }
        .dot.ok { background: var(--ok); }
        .dot.warn { background: var(--warn); }
        .dot.bad { background: var(--danger); }

        .kv {
            display: grid;
            grid-template-columns: 170px 1fr;
            gap: 6px 10px;
            font-size: 13px;
        }

        code {
            background: #0f1220;
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .12);
        }

        input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .18);
            background: #0f1220;
            color: var(--text);
        }

        textarea {
            min-height: 220px;
            resize: vertical;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.3;
        }

        .divider { height: 1px; background: rgba(255, 255, 255, .10); margin: 6px 0; }

        .log {
            height: calc(100vh - 48px);
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.35;
            padding: 12px;
            border-radius: 14px;
            background: #0f1220;
            border: 1px solid rgba(255, 255, 255, .12);
            white-space: pre-wrap;
        }

        .pillbar { display: flex; gap: 8px; flex-wrap: wrap; }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="panel col">
            <div>
                <h1>Doggo Hub</h1>
                <div class="muted">Runtime controller using JSON movement programs.</div>
            </div>

            <div class="row">
                <span class="badge"><span class="dot" id="dotEnabled"></span><span id="txtEnabled">enabled: false</span></span>
                <span class="badge"><span class="dot" id="dotRunning"></span><span id="txtRunning">running: false</span></span>
            </div>

            <div class="pillbar">
                <span class="badge"><span class="dot" id="dotConfig"></span><span id="txtConfig">config: not loaded</span></span>
                <span class="badge"><span class="dot" id="dotProgram"></span><span id="txtProgram">program: not loaded</span></span>
                <span class="badge"><span class="dot" id="dotHw"></span><span id="txtHw">hardware: unknown</span></span>
            </div>

            <div class="divider"></div>

            <div class="row">
                <button class="primary" id="btnLoadConfig">Load Config</button>
                <button class="primary" id="btnLoadProgram">Load Program JSON</button>
                <button class="primary" id="btnCompile">Compile</button>
            </div>

            <div class="col">
                <div class="muted">Program JSON</div>
                <textarea id="inpProgram"></textarea>
            </div>

            <div class="row">
                <button class="primary" id="btnEnable">Enable</button>
                <button class="primary" id="btnStart">Start</button>
                <button class="danger" id="btnStop">Stop</button>
                <button class="danger" id="btnEstop">E-Stop</button>
            </div>

            <div class="divider"></div>

            <div class="col">
                <div style="font-weight:800;">Runtime Settings</div>
                <div class="row">
                    <div style="flex:1;">
                        <div class="muted">heartbeat_timeout_ms (0=off)</div>
                        <input id="inpHeartbeat" type="number" min="0" step="100" />
                    </div>
                    <label class="muted" style="display:flex; align-items:center; gap:8px;">
                        <input id="inpStopOnClamp" type="checkbox" /> stop_on_clamp
                    </label>
                </div>
                <div class="row">
                    <div style="flex:1;">
                        <div class="muted">max_delta_per_tick (compile)</div>
                        <input id="inpMaxDelta" type="number" min="1" step="1" placeholder="optional" />
                    </div>
                    <label class="muted" style="display:flex; align-items:center; gap:8px;">
                        <input id="inpSparse" type="checkbox" checked /> sparse targets
                    </label>
                </div>
                <div class="row">
                    <button id="btnApplySettings" class="primary">Apply Settings</button>
                    <button id="btnPreview" class="primary">Preview</button>
                    <button id="btnTelemetry" class="primary">Telemetry Tail</button>
                </div>
            </div>

            <div class="divider"></div>

            <div>
                <div style="font-weight:800; margin-bottom:8px;">Status</div>
                <div class="kv">
                    <div class="muted">program_name</div><div id="kvProg">-</div>
                    <div class="muted">compiled_summary</div><div id="kvCompiled">-</div>
                    <div class="muted">packet_idx</div><div id="kvPacket">-</div>
                    <div class="muted">last_run_reason</div><div id="kvRunReason">-</div>
                    <div class="muted">hardware_lock_owner</div><div id="kvLockOwner">-</div>
                    <div class="muted">telemetry_count</div><div id="kvTelemetry">-</div>
                    <div class="muted">last_warning</div><div id="kvWarning">-</div>
                    <div class="muted">hardware_error</div><div id="kvHwErr">-</div>
                </div>
            </div>

            <div class="row">
                <button id="btnRefresh">Refresh</button>
                <span class="muted">Auto-refresh every 500ms.</span>
            </div>
        </div>

        <div class="panel">
            <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <div>
                    <h1 style="margin:0;">Console</h1>
                    <div class="muted">API responses, preview, and telemetry output.</div>
                </div>
                <div class="row"><button id="btnClear">Clear</button></div>
            </div>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById("log");
        function log(msg) {
            const ts = new Date().toLocaleTimeString();
            logEl.textContent += `[${ts}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        function fmt(v) { return (v === null || v === undefined || String(v).trim() === "") ? "-" : String(v); }

        async function api(url, method = "GET", body = null) {
            const opts = { method, headers: {} };
            if (body !== null) {
                opts.headers["Content-Type"] = "application/json";
                opts.body = JSON.stringify(body);
            }
            const res = await fetch(url, opts);
            const data = await res.json();
            return { ok: res.ok, status: res.status, data };
        }

        function setBadge(dotId, txtId, ok, warn = false, text = "") {
            const dot = document.getElementById(dotId);
            const txt = document.getElementById(txtId);
            dot.className = "dot" + (ok ? " ok" : (warn ? " warn" : " bad"));
            txt.textContent = text;
        }

        function defaultProgram() {
            return {
                program_id: "hub_program",
                tick_ms: 20,
                steps: [
                    {
                        step_id: "rear_hips",
                        commands: [
                            { location: "rear_left_hip", target_angle: 150, duration_ms: 300, easing: "ease_in_out" },
                            { location: "rear_right_hip", target_angle: 150, duration_ms: 300, easing: "ease_in_out" }
                        ]
                    },
                    {
                        step_id: "rear_knees",
                        commands: [
                            { location: "rear_left_knee", target_angle: 120, duration_ms: 250, easing: "ease_in_out" },
                            { location: "rear_right_knee", target_angle: 120, duration_ms: 250, easing: "ease_in_out" }
                        ]
                    }
                ]
            };
        }

        function updateButtons(st) {
            document.getElementById("btnStart").disabled = !(st.enabled && st.config_loaded && st.program_loaded && !st.running && st.compiled_loaded);
            document.getElementById("btnStop").disabled = !st.running && !st.enabled;
            document.getElementById("btnEstop").disabled = false;
        }

        function renderStatus(st) {
            setBadge("dotEnabled", "txtEnabled", !!st.enabled, false, `enabled: ${!!st.enabled}`);
            setBadge("dotRunning", "txtRunning", !!st.running, false, `running: ${!!st.running}`);
            setBadge("dotConfig", "txtConfig", !!st.config_loaded, false, `config: ${st.config_loaded ? "loaded" : "not loaded"}`);
            setBadge("dotProgram", "txtProgram", !!st.program_loaded, false, `program: ${st.program_loaded ? "loaded" : "not loaded"}`);

            const hwOk = !!st.hardware_available;
            const hwWarn = !hwOk && st.hardware_error;
            setBadge("dotHw", "txtHw", hwOk, hwWarn, `hardware: ${hwOk ? "available" : "unavailable"}`);

            document.getElementById("kvProg").textContent = fmt(st.program_name);
            document.getElementById("kvCompiled").textContent = st.compiled_summary ? `${st.compiled_summary.num_ticks} ticks @ ${st.compiled_summary.tick_ms}ms` : "-";
            document.getElementById("kvPacket").textContent = fmt(st.packet_idx);
            document.getElementById("kvRunReason").textContent = fmt(st.last_run_reason);
            document.getElementById("kvLockOwner").textContent = fmt(st.hardware_lock_owner);
            document.getElementById("kvTelemetry").textContent = fmt(st.telemetry_count);
            document.getElementById("kvWarning").textContent = fmt(st.last_warning);
            document.getElementById("kvHwErr").textContent = fmt(st.hardware_error);

            if (!document.getElementById("inpHeartbeat").value) document.getElementById("inpHeartbeat").value = st.heartbeat_timeout_ms;
            document.getElementById("inpStopOnClamp").checked = !!st.stop_on_clamp;

            updateButtons(st);
        }

        async function refreshStatus() {
            const resp = await api("/api/status");
            if (!resp.ok) {
                log(`ERR /api/status (${resp.status})`);
                return;
            }
            renderStatus(resp.data);
        }

        function parseProgramInput() {
            const txt = String(document.getElementById("inpProgram").value || "").trim();
            if (!txt) return { ok: false, error: "Program JSON is empty." };
            try {
                return { ok: true, value: JSON.parse(txt) };
            } catch (e) {
                return { ok: false, error: `Invalid JSON: ${e}` };
            }
        }

        document.getElementById("btnLoadConfig").addEventListener("click", async () => {
            const resp = await api("/api/load_config", "POST", {});
            log(`POST /api/load_config -> ${resp.status} ${resp.data.message || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnLoadProgram").addEventListener("click", async () => {
            const parsed = parseProgramInput();
            if (!parsed.ok) { log(parsed.error); return; }
            const resp = await api("/api/load_program_json", "POST", { program: parsed.value });
            log(`POST /api/load_program_json -> ${resp.status} ${resp.data.message || resp.data.error || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnCompile").addEventListener("click", async () => {
            const sparse_targets = !!document.getElementById("inpSparse").checked;
            const maxDeltaRaw = String(document.getElementById("inpMaxDelta").value || "").trim();
            const body = { sparse_targets };
            if (maxDeltaRaw) body.max_delta_per_tick = Number(maxDeltaRaw);
            const resp = await api("/api/compile_program", "POST", body);
            log(`POST /api/compile_program -> ${resp.status} ${resp.data.message || resp.data.error || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnEnable").addEventListener("click", async () => {
            const resp = await api("/api/enable", "POST", {});
            log(`POST /api/enable -> ${resp.status} ${resp.data.message || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnStart").addEventListener("click", async () => {
            const resp = await api("/api/start", "POST", {});
            log(`POST /api/start -> ${resp.status} ${resp.data.message || resp.data.error || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnStop").addEventListener("click", async () => {
            const resp = await api("/api/stop", "POST", {});
            log(`POST /api/stop -> ${resp.status} ${resp.data.message || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnEstop").addEventListener("click", async () => {
            const resp = await api("/api/estop", "POST", {});
            log(`POST /api/estop -> ${resp.status} ${resp.data.message || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnApplySettings").addEventListener("click", async () => {
            const heartbeat_timeout_ms = parseFloat(document.getElementById("inpHeartbeat").value || "0");
            const stop_on_clamp = !!document.getElementById("inpStopOnClamp").checked;
            const resp = await api("/api/settings", "POST", { heartbeat_timeout_ms, stop_on_clamp });
            log(`POST /api/settings -> ${resp.status} ${resp.data.error || ""}`);
            renderStatus(resp.data.status || resp.data);
        });

        document.getElementById("btnPreview").addEventListener("click", async () => {
            const resp = await api("/api/program_preview?count=20");
            log(`GET /api/program_preview -> ${resp.status}`);
            if (resp.ok) log(JSON.stringify(resp.data, null, 2));
            else log(JSON.stringify(resp.data));
        });

        document.getElementById("btnTelemetry").addEventListener("click", async () => {
            const resp = await api("/api/telemetry?tail=20");
            log(`GET /api/telemetry -> ${resp.status}`);
            if (resp.ok) log(JSON.stringify(resp.data, null, 2));
            else log(JSON.stringify(resp.data));
        });

        document.getElementById("btnRefresh").addEventListener("click", refreshStatus);
        document.getElementById("btnClear").addEventListener("click", () => { logEl.textContent = ""; });

        document.getElementById("inpProgram").value = JSON.stringify(defaultProgram(), null, 2);

        refreshStatus();
        setInterval(async () => {
            await refreshStatus();
            const enabled = document.getElementById("txtEnabled").textContent.includes("true");
            if (enabled) await api("/api/heartbeat", "POST", {});
        }, 500);
    </script>
</body>

</html>
