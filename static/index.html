<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Doggo Controller</title>
    <style>
        :root {
            --bg: #0f1220;
            --panel: #181c2f;
            --accent: #4da3ff;
            --text: #e6e8f0;
            --muted: #9aa0b3;
            --selected: #263a5f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: grid;
            grid-template-columns: 1fr 260px;
            grid-template-rows: 1fr 90px;
            height: 100vh;
        }

        /* ---------- Main panel ---------- */
        #main {
            padding: 12px;
        }

        #robot-panel {
            position: relative;
            height: 100%;
            background: var(--panel);
            border-radius: 10px;
            overflow: hidden;
        }

        #robot-panel img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0.85;
        }

        .widget {
            position: absolute;
            background: rgba(0, 0, 0, 0.55);
            padding: 6px;
            border-radius: 6px;
            width: 160px;
            border: 1px solid transparent;
        }

        .widget.selected {
            border-color: var(--accent);
            background: var(--selected);
        }

        .widget label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .widget select,
        .widget button {
            width: 100%;
            margin-top: 4px;
        }

        .widget button.selected-btn {
            background: var(--accent);
            color: black;
            font-weight: 600;
        }

        /* ---------- Sidebar ---------- */
        #sidebar {
            padding: 12px;
            background: #14172a;
            border-left: 1px solid #222;
        }

        #sidebar button {
            width: 100%;
            margin-bottom: 8px;
            padding: 10px;
            font-size: 14px;
        }

        #sidebar button:disabled {
            opacity: 0.4;
        }

        /* ---------- Control bar ---------- */
        #controls {
            grid-column: 1 / span 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            background: #111427;
            border-top: 1px solid #222;
        }

        .control-group {
            display: flex;
            gap: 6px;
        }

        #angle-display {
            font-size: 32px;
            min-width: 100px;
            text-align: center;
        }

        button {
            padding: 6px 10px;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <!-- MAIN IMAGE PANEL -->
    <div id="main">
        <div id="robot-panel">
            <!-- replace with your own image if you want -->
            <img src="https://dummyimage.com/800x600/1a1f3a/ffffff&text=Doggo" alt="Doggo">

            <!-- widgets injected here -->
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <button id="saveBtn" disabled>Save</button>
        <button id="resetBtn" disabled>Reset</button>
    </div>

    <!-- CONTROL BAR -->
    <div id="controls">
        <div class="control-group">
            <button data-step="-10">-10</button>
            <button data-step="-5">-5</button>
            <button data-step="-1">-1</button>
        </div>

        <div id="angle-display">0°</div>

        <div class="control-group">
            <button data-step="1">+1</button>
            <button data-step="5">+5</button>
            <button data-step="10">+10</button>
        </div>
    </div>

    <script>
        /* -------------------- State -------------------- */
        let locations = [];
        let draftMapping = {};
        let availableChannels = [];
        let selectedLocation = null;
        let currentAngle = 0;

        /* Widget layout (percent-based, tweak freely) */
        const widgetPositions = {
            front_left_hip: { x: 15, y: 30 },
            front_left_knee: { x: 15, y: 45 },
            front_right_hip: { x: 70, y: 30 },
            front_right_knee: { x: 70, y: 45 },
            back_left_hip: { x: 25, y: 65 },
            back_left_knee: { x: 25, y: 80 },
            back_right_hip: { x: 60, y: 65 },
            back_right_knee: { x: 60, y: 80 },
        };

        /* -------------------- API helpers -------------------- */
        async function api(url, method = "GET", body = null) {
            const opts = { method, headers: {} };
            if (body) {
                opts.headers["Content-Type"] = "application/json";
                opts.body = JSON.stringify(body);
            }
            const res = await fetch(url, opts);
            return res.json();
        }

        /* -------------------- Render -------------------- */
        function renderWidgets() {
            const panel = document.getElementById("robot-panel");
            panel.querySelectorAll(".widget").forEach(w => w.remove());

            locations.forEach(loc => {
                const w = document.createElement("div");
                w.className = "widget";
                if (loc.key === selectedLocation) w.classList.add("selected");

                const pos = widgetPositions[loc.key];
                w.style.left = pos.x + "%";
                w.style.top = pos.y + "%";

                const label = document.createElement("label");
                label.textContent = loc.label;
                w.appendChild(label);

                const sel = document.createElement("select");
                const current = draftMapping[loc.key];

                const optNone = new Option("Unassigned", "");
                sel.add(optNone);

                if (current !== null && current !== undefined) {
                    sel.add(new Option(current, current));
                }

                availableChannels.forEach(ch => {
                    sel.add(new Option(ch, ch));
                });

                sel.value = current ?? "";
                sel.onchange = async () => {
                    const val = sel.value === "" ? null : Number(sel.value);
                    const r = await api("/api/mapping", "POST", {
                        location: loc.key,
                        channel: val
                    });
                    syncFromBackend(r);
                };

                w.appendChild(sel);

                const btn = document.createElement("button");
                btn.textContent = loc.key === selectedLocation ? "Selected" : "Select";
                if (loc.key === selectedLocation) {
                    btn.classList.add("selected-btn");
                    btn.disabled = true;
                }
                btn.onclick = () => {
                    selectedLocation = loc.key;
                    renderWidgets();
                };

                w.appendChild(btn);
                panel.appendChild(w);
            });
        }

        function renderControls() {
            document.getElementById("angle-display").textContent = currentAngle + "°";
        }

        function syncFromBackend(data) {
            draftMapping = data.draft_mapping ?? draftMapping;
            availableChannels = data.available_channels ?? availableChannels;

            document.getElementById("saveBtn").disabled = !data.save_enabled;
            document.getElementById("resetBtn").disabled = !data.reset_enabled;

            renderWidgets();
        }

        /* -------------------- Controls -------------------- */
        document.querySelectorAll("#controls button[data-step]").forEach(btn => {
            btn.onclick = async () => {
                if (!selectedLocation) return;
                const step = Number(btn.dataset.step);
                currentAngle = Math.max(0, Math.min(270, currentAngle + step));
                renderControls();
                await api("/api/command", "POST", {
                    location: selectedLocation,
                    angle_deg: currentAngle
                });
            };
        });

        document.getElementById("saveBtn").onclick = async () => {
            await api("/api/save", "POST");
            await load();
        };

        document.getElementById("resetBtn").onclick = async () => {
            const r = await api("/api/reset", "POST");
            syncFromBackend(r);
        };

        /* -------------------- Init -------------------- */
        async function load() {
            const data = await api("/api/config");
            locations = data.locations;
            draftMapping = data.draft_mapping;
            availableChannels = data.available_channels;
            document.getElementById("saveBtn").disabled = !data.save_enabled;
            document.getElementById("resetBtn").disabled = !data.reset_enabled;
            renderWidgets();
            renderControls();
        }

        load();
    </script>
</body>

</html>